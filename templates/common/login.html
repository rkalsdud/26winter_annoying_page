{% extends "base.html" %}
{% block content %}
<div class="container my-3">
    <form method="post" action="{% url 'common:login' %}" id="login-form">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ next }}">  <!-- 로그인 성공후 이동되는 URL -->
        {% include "form_errors.html" %}
        <div class="mb-3">
            <label for="username">사용자ID</label>
            <input type="text" class="form-control" name="username" id="username"
                   value="{{ form.username.value|default_if_none:'' }}">
        </div>
        <div class="mb-3">
            <label>비밀번호 입력 (격자를 클릭한 후 방향키로 조작)</label>
            <div id="login-grid" class="grid-body" tabindex="0" 
                 style="display: grid; grid-template-columns: repeat(5, 50px); gap: 5px; background: #f8f9fa; padding: 10px; border: 2px solid #dee2e6; width: fit-content; outline: none;">
                </div>
            <small id="path-text" class="text-muted">경로: (대기 중)</small>
            <input type="hidden" name="password" id="password-input">
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">로그인</button>
            <button type="button" class="btn btn-secondary" onclick="resetPath()">초기화</button>
        </div>
    </form>
</div>

<style>
    /* 포커스 되었을 때 테두리 색상 변경 (signup.html 방식) */
    .grid-body:focus { border-color: #0d6efd !important; background-color: #fff !important; }
    .grid-cell { width: 50px; height: 50px; border: 1px solid #dee2e6; display: flex; align-items: center; justify-content: center; background: white; }
    .entity { font-size: 24px; color: #0d6efd; }
</style>

<script>
    const size = 5;
    let pos = { x: 2, y: 2 }; // 중앙 시작
    let path = [];

    function drawGrid() {
        const container = document.getElementById('login-grid');
        container.innerHTML = '';
        
        for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                if (x === pos.x && y === pos.y) {
                    cell.innerHTML = '<span class="entity">●</span>';
                }
                container.appendChild(cell);
            }
        }
        // 숨겨진 input과 텍스트 업데이트
        document.getElementById('password-input').value = path.join('');
        document.getElementById('path-text').innerText = `경로: ${path.join('→') || '(대기 중)'}`;
    }

    function handleKey(e) {
        // 격자에 포커스가 있을 때만 작동
        if (document.activeElement.id !== 'login-grid') {
            // 만약 엔터키라면 로그인 시도
            if (e.key === 'Enter' && path.length > 0) {
                document.getElementById('login-form').submit();
            }
            return;
        }

        let moved = false;
        if (e.key === 'ArrowUp' && pos.y > 0) { pos.y--; path.push('U'); moved = true; }
        else if (e.key === 'ArrowDown' && pos.y < size - 1) { pos.y++; path.push('D'); moved = true; }
        else if (e.key === 'ArrowLeft' && pos.x > 0) { pos.x--; path.push('L'); moved = true; }
        else if (e.key === 'ArrowRight' && pos.x < size - 1) { pos.x++; path.push('R'); moved = true; }
        else if (e.key === 'Enter') {
            if (path.length > 0) {
                document.getElementById('login-form').submit();
            }
        }

        if (moved) {
            e.preventDefault(); // 스크롤 방지
            drawGrid();
        }
    }

    function resetPath() {
        pos = { x: 2, y: 2 };
        path = [];
        drawGrid();
    }

    // 이벤트 리스너 등록
    window.addEventListener('keydown', handleKey);
    document.addEventListener('DOMContentLoaded', drawGrid);
</script>
{% endblock %}