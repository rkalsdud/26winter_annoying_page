{% extends "base.html" %}
{% block content %}
<div class="container my-3">
    <form method="post" action="{% url 'common:signup' %}" id="signup-form">
        {% csrf_token %}
        {% include "form_errors.html" %}
        <div class="mb-3">
            <label for="username">사용자 이름</label>
            <input type="text" class="form-control" name="username" id="username"
                   value="{{ form.username.value|default_if_none:'' }}">
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>비밀번호 설정 (격자 1)</label>
                <div id="grid-1" class="grid-body" tabindex="0" style="display: grid; grid-template-columns: repeat(5, 50px); gap: 5px; background: #f8f9fa; padding: 10px; border: 2px solid #dee2e6; width: fit-content; outline: none;">
                    </div>
                <small id="path-1-text" class="text-muted">경로: (대기 중)</small>
                <input type="hidden" name="password1" id="password1-input">
            </div>

            <div class="col-md-6 mb-3">
                <label>비밀번호 확인 (격자 2)</label>
                <div id="grid-2" class="grid-body" tabindex="0" style="display: grid; grid-template-columns: repeat(5, 50px); gap: 5px; background: #f8f9fa; padding: 10px; border: 2px solid #dee2e6; width: fit-content; outline: none;">
                    </div>
                <small id="path-2-text" class="text-muted">경로: (대기 중)</small>
                <input type="hidden" name="password2" id="password2-input">
            </div>
        </div>

        <div class="mb-3">
            <label for="email">이메일</label>
            <input type="text" class="form-control" name="email" id="email"
                   value="{{ form.email.value|default_if_none:'' }}">
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">생성하기</button>
            <button type="button" class="btn btn-secondary" onclick="resetAll()">초기화</button>
        </div>
    </form>
</div>

<style>
    .grid-body:focus { border-color: #0d6efd !important; background-color: #fff !important; }
    .grid-cell { width: 50px; height: 50px; border: 1px solid #dee2e6; display: flex; align-items: center; justify-content: center; background: white; }
    .entity { font-size: 24px; color: #0d6efd; }
</style>

<script>
    const size = 5;
    let state = {
        'grid-1': { pos: { x: 2, y: 2 }, path: [], inputId: 'password1-input', textId: 'path-1-text' },
        'grid-2': { pos: { x: 2, y: 2 }, path: [], inputId: 'password2-input', textId: 'path-2-text' }
    };

    function drawGrid(gridId) {
        const container = document.getElementById(gridId);
        const data = state[gridId];
        container.innerHTML = '';
        
        for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                if (x === data.pos.x && y === data.pos.y) {
                    cell.innerHTML = '<span class="entity">●</span>';
                }
                container.appendChild(cell);
            }
        }
        document.getElementById(data.inputId).value = data.path.join('');
        document.getElementById(data.textId).innerText = `경로: ${data.path.join('→') || '(대기 중)'}`;
    }

    function handleKey(e) {
        const activeId = document.activeElement.id;
        if (!state[activeId]) return;

        let moved = false;
        const data = state[activeId];

        if (e.key === 'ArrowUp' && data.pos.y > 0) { data.pos.y--; data.path.push('U'); moved = true; }
        else if (e.key === 'ArrowDown' && data.pos.y < size - 1) { data.pos.y++; data.path.push('D'); moved = true; }
        else if (e.key === 'ArrowLeft' && data.pos.x > 0) { data.pos.x--; data.path.push('L'); moved = true; }
        else if (e.key === 'ArrowRight' && data.pos.x < size - 1) { data.pos.x++; data.path.push('R'); moved = true; }

        if (moved) {
            e.preventDefault();
            drawGrid(activeId);
        }
    }

    function resetAll() {
        Object.keys(state).forEach(id => {
            state[id].pos = { x: 2, y: 2 };
            state[id].path = [];
            drawGrid(id);
        });
    }

    // 초기화 및 이벤트 리스너 등록
    window.addEventListener('keydown', handleKey);
    document.addEventListener('DOMContentLoaded', () => {
        drawGrid('grid-1');
        drawGrid('grid-2');
    });

    // 폼 제출 전 검증 (선택 사항)
    document.getElementById('signup-form').onsubmit = function() {
        if (state['grid-1'].path.join('') !== state['grid-2'].path.join('')) {
            alert("비밀번호 경로가 서로 일치하지 않습니다.");
            return false;
        }
        return true;
    };
</script>
{% endblock %}